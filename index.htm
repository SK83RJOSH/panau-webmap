<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Panau Overview Map</title>
	<script src="http://threejs.org/build/three.min.js"></script>
	<script src="MapControls.js"></script>
	<script>
		var scene, camera, ambient, shader, renderer, controls;
		var geometry, texture, displacement, sky, uniforms, material, mesh;

		function init() {
			scene = new THREE.Scene();
			scene.fog = new THREE.FogExp2(0xefd1b5, 0.035)

			camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 1028);
			camera.position.y = -10;
			camera.position.z = 10;
			camera.lookAt(new THREE.Vector3())

			shader = THREE.ShaderLib['normalmap'];
			geometry = new THREE.PlaneGeometry(16, 16, 256, 256);
			geometry.computeTangents();
			texture = THREE.ImageUtils.loadTexture('map_diffuse.jpg');
			texture.minFilter = texture.magFilter = THREE.LinearFilter;
			displacement = THREE.ImageUtils.loadTexture('map_displacement.jpg');
			sky = THREE.ImageUtils.loadTexture('sky_palette.jpg');

			uniforms = THREE.UniformsUtils.clone(shader.uniforms);
			uniforms["enableDiffuse"].value = true;
			uniforms["tDiffuse"].value = texture;
			uniforms["enableDisplacement"].value = true;
			uniforms["tDisplacement"].value = displacement;
			uniforms["uDisplacementScale"].value = 1;
			
			material = new THREE.ShaderMaterial({
				fragmentShader: shader.fragmentShader,
				vertexShader: shader.vertexShader,
				uniforms: uniforms,
				lights: true,
				fog: true
			});

			mesh = new THREE.Mesh(geometry, material);
			scene.add(mesh);

			ambientLight = new THREE.AmbientLight(0x526f99);
			scene.add(ambientLight);

			renderer = new THREE.WebGLRenderer({
				antialias: true,
				precision: 'highp'
			});
			renderer.setClearColor(0x526f99);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.physicallyBasedShading = true;

			controls = new THREE.MapControls(camera, renderer.domElement);

			document.body.appendChild(renderer.domElement);
		}

		function animate() {
			requestAnimationFrame(animate);
			renderer.render(scene, camera);
		}

		window.addEventListener('resize', function() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		});

		function componentToHex(c) {
			var hex = c.toString(16);
			return hex.length == 1 ? '0' + hex : hex;
		}

		function getImageData(image) {
			var canvas = document.createElement('canvas');
			canvas.width = image.width;
			canvas.height = image.height;

			var context = canvas.getContext('2d');
			context.drawImage(image, 0, 0);

			return context.getImageData(0, 0, image.width, image.height);
		}

		function getPixel(image, x, y) {
			var position = (x + image.width * y) * 4;
			var data = getImageData(image).data;

			return new THREE.Color(data[position] / 255, data[position + 1] / 255, data[position + 2] / 255).getHex();
		}

		function setTime(time) {
			renderer.setClearColor(getPixel(sky.image, Math.round((time / 24) * 255), 0));
			ambientLight.color = renderer.getClearColor();
		}

		var time = 0;
	</script>
	<style>
		body, html {
			padding: 0;
			margin: 0;
			overflow: hidden;
		}

		canvas {
			position: fixed;
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body onload="init(); animate();"></body>
</html>